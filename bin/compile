#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>



# ------------------------------------------------------------
# Configure directories
# ------------------------------------------------------------
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
TMP_DIR=$(mktemp -d)
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
PROFILE_SCRIPT="$BUILD_DIR/.profile.d/mysql.sh"
# ------------------------------------------------------------



# ------------------------------------------------------------
# Configure environment
# ------------------------------------------------------------
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps
# ------------------------------------------------------------



# ------------------------------------------------------------
VERSION=mysql-8.0.12-linux-glibc2.12-x86_64
# ------------------------------------------------------------



# ------------------------------------------------------------
download_and_unpack() {
# ------------------------------------------------------------
  echo '       * Downloading source code'
  curl -# -L -o "$TMP_DIR/$VERSION.tar.xz" "https://dev.mysql.com/get/Downloads/MySQL-8.0/$VERSION.tar.xz"

  echo '       * Unpacking'
  tar -C "$CACHE_DIR" -xJf "$TMP_DIR/$VERSION.tar.xz"
  cp "$BP_DIR"/lib/lib*.so* "$CACHE_DIR/$VERSION/lib"  
}
# ------------------------------------------------------------



# ------------------------------------------------------------
install() {
# ------------------------------------------------------------
  echo '       * Installing'
  mkdir -p "$BUILD_DIR/.heroku/vendor"
  cp -r "$CACHE_DIR/$VERSION" "$BUILD_DIR/.heroku/vendor/mysql"
}
# ------------------------------------------------------------




# ------------------------------------------------------------
configure() {
# ------------------------------------------------------------
  echo '       * Setup'

  cd "$BUILD_DIR/.heroku/vendor/mysql"

  mkdir -p mysql-files
  chmod 750 mysql-files

  mkdir -p data
  chmod 750 data

  export LD_LIBRARY_PATH=lib:${LD_LIBRARY_PATH:-}

  bin/mysqld --initialize-insecure  --datadir=data
  bin/mysql_ssl_rsa_setup --datadir=data

  export DATABASE_URL=mysql2://user:password@localhost/tempdb
}
# ------------------------------------------------------------




##############################################################

if [ ! -d $CACHE_DIR/$VERSION ]; then
  download_and_unpack
fi

install

configure

##############################################################


